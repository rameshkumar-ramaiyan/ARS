
(function ($) {

    // Register plugin
    tinymce.PluginManager.add('fsmediapicker', function (editor) {

        function populate(path) {

            var text = editor.selection.getContent() ? editor.selection.getContent() : '';

            if ((/\.(jpe?g|png|gif)$/i).test(path) && text == '') {

                var data = {
                    src: (path) ? path : 'nothing.jpg',
                    alt: path
                };

                editor.insertContent(editor.dom.createHTML('img', data));

            } else {

                var data = {
                    href: path,
                    title: path,
                    target: '_blank'
                };

                editor.insertContent(editor.dom.createHTML('a', data, text));
            }

        };

        editor.addButton('fsmediapicker', {
            icon: 'custom icon-files',
            tooltip: 'File System Picker',
            onclick: function () {

                //get your angular element
                var elem = angular.element(document.querySelector('[ng-controller]'));

                //get the scope.
                var $scope = elem.scope();

                //get the injector.
                var injector = elem.injector();

                //get the services.
                var dialogService = injector.get('dialogService');
                var $routeParams = injector.get('$routeParams');
                var $http = injector.get('$http');
                var $log = injector.get('$log');
                
                var startFolder = '/images';
                var removeChars = '-';
                var alias = 'modeCode';
                $http.get('/umbraco/backoffice/FileSystemPicker/FileSystemPickerApi/GetCommonConfig/')
                    .then(function (response) {

                        startFolder = response.data.startFolder;
                        alias = response.data.startFolderNamePropertyAlias;
                        removeChars = response.data.removeCharactersPropertyAlias;

                        var id = $routeParams.id;
                        $http.get('/umbraco/backoffice/FileSystemPicker/FileSystemPickerApi/GetStartFolderName/?startFolderNamePropertyAlias=' + alias + '&currentNodeId=' + id + '&removeCharactersPropertyAlias=' + removeChars)
                            .then(function (response) {
                                if (response && response.data && response.data.folderName != null) {
                                    startFolder = startFolder + '/' + response.data.folderName;
                                }

                                fileSystemPickerTreeDialog = dialogService.open({
                                    template: '/App_Plugins/FileSystemPicker/filesystem-picker-dialog.html',
                                    callback: populate,
                                    dialogData: {
                                        filter: '',
                                        folder: startFolder
                                    }
                                });

                            }, function (data) {
                                $log.error(data)
                            });

                    }, function (data) {
                        $log.error(data)
                    });
            }
        });
    });

})(jQuery);